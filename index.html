<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>單字學習考試 V14</title>
  <!-- Firebase 相容版本 -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    // 請將下列 firebaseConfig 替換為您的設定
    const firebaseConfig = {
      apiKey: "AIzaSyDvHvJBoDrfqXMZ-04DV6cmx-6ggw_skl0",
      authDomain: "engg-3c3b6.firebaseapp.com",
      projectId: "engg-3c3b6",
      storageBucket: "engg-3c3b6.firebasestorage.app",
      messagingSenderId: "703539214129",
      appId: "1:703539214129:web:b97b1f3c4cb51fbe88e210",
      measurementId: "G-HXC84CTPGL"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>
  <style>
    /* 全站風格：背景黑色，按鈕無陰影 */
    body {
      font-family: Arial, sans-serif;
      background: #000;
      color: #fff;
      text-align: center;
      margin: 20px;
    }
    h1, h2 {
      margin-bottom: 20px;
    }
    header button {
      padding: 8px 16px;
      font-size: 16px;
      margin: 0 5px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background-color: #007bff;
      color: #fff;
    }
    header button:hover {
      background-color: #0056b3;
    }
    /* 學習模式 */
    #vocabPanel {
      display: block;
      padding: 15px;
      background: #222;
      border-radius: 8px;
      border: 1px solid #444;
      margin-bottom: 20px;
    }
    .word-container {
      display: inline-block;
      margin: 10px;
      padding: 10px;
      background: #333;
      border-radius: 8px;
      width: 140px;
      vertical-align: top;
    }
    .word-container button {
      width: 100%;
      padding: 8px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      background-color: #007bff;
      color: #fff;
      cursor: pointer;
    }
    .word-container button:hover {
      background-color: #0056b3;
    }
    .extra {
      margin-top: 8px;
      font-size: 14px;
    }
    .extra img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border: 1px solid #ccc;
    }
    .toggle-buttons {
      margin-top: 20px;
    }
    .toggle-buttons button {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      margin: 0 10px;
      cursor: pointer;
      background-color: #28a745;
      color: #fff;
    }
    .toggle-buttons button:hover {
      background-color: #218838;
    }
    /* 考試設定區 */
    #examSettings {
      display: none;
      padding: 15px;
      background: #222;
      border-radius: 8px;
      border: 1px solid #444;
      margin-bottom: 20px;
    }
    #examSettings input, #examSettings select {
      padding: 5px;
      font-size: 16px;
      margin: 5px;
    }
    #examSettings label {
      margin-right: 10px;
    }
    #examSettings button {
      padding: 8px 16px;
      font-size: 16px;
      margin-top: 10px;
      border: none;
      border-radius: 4px;
      background-color: #007bff;
      color: #fff;
      cursor: pointer;
    }
    #examSettings button:hover {
      background-color: #0056b3;
    }
    /* 考試模式 */
    #examPanel {
      display: none;
      padding: 15px;
      background: #222;
      border-radius: 8px;
      border: 1px solid #444;
      margin-bottom: 20px;
    }
    #examPanel p {
      margin: 10px 0;
      font-size: 18px;
    }
    #examQuestionBtn {
      padding: 12px 20px;
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 15px;
      border: none;
      border-radius: 4px;
      background-color: #007bff;
      color: #fff;
      cursor: pointer;
    }
    #examQuestionBtn:hover {
      background-color: #0056b3;
    }
    #optionsContainer {
      margin: 15px 0;
    }
    #optionsContainer button.option {
      padding: 10px 15px;
      font-size: 16px;
      margin: 5px;
      border: none;
      border-radius: 4px;
      background-color: #28a745;
      color: #fff;
      cursor: pointer;
      min-width: 120px;
    }
    #optionsContainer button.option:hover {
      background-color: #218838;
    }
    /* 下一題按鈕 */
    #nextBtn {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      background-color: #007bff;
      color: #fff;
      cursor: pointer;
      display: none;
      margin-top: 15px;
    }
    #nextBtn:hover {
      background-color: #0056b3;
    }
    .examInfo {
      font-size: 18px;
      margin: 5px 0;
    }
    /* 答錯顯示區 */
    #correctDisplay {
      font-size: 18px;
      color: #ff4444;
      margin-top: 10px;
    }
    #correctDisplay img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border: 1px solid #ccc;
      display: block;
      margin: 5px auto;
      cursor: pointer;
    }
    /* 結果與排行榜區 */
    #resultPanel {
      display: none;
      padding: 15px;
      background: #222;
      border-radius: 8px;
      border: 1px solid #444;
      margin-top: 20px;
    }
    #resultPanel table {
      margin: 0 auto;
      border-collapse: collapse;
    }
    #resultPanel th, #resultPanel td {
      padding: 8px 12px;
      border: 1px solid #666;
    }
    #resultPanel button {
      margin-top: 15px;
      padding: 8px 16px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      background-color: #007bff;
      color: #fff;
      cursor: pointer;
    }
    #resultPanel button:hover {
      background-color: #0056b3;
    }
    /* 全站排行榜 */
    #globalLeaderboard {
      margin-top: 30px;
      padding: 15px;
      background: #222;
      border-radius: 8px;
      border: 1px solid #444;
    }
    #globalLeaderboard table {
      margin: 0 auto;
      border-collapse: collapse;
    }
    #globalLeaderboard th, #globalLeaderboard td {
      padding: 8px 12px;
      border: 1px solid #666;
    }
  </style>
</head>
<body>
  <header>
    <button onclick="showMode('vocab')">學習模式</button>
    <button onclick="showMode('examSetup')">考試模式</button>
    <!-- 結束考試按鈕放在 header，僅考試進行中時顯示 -->
    <button id="headerFinishExamBtn" onclick="headerFinishExam()" style="display:none;">結束考試</button>
  </header>
  
  <!-- 學習模式 -->
  <div id="vocabPanel">
    <h2>學習模式</h2>
    <div id="vocabContainer"></div>
    <div class="toggle-buttons">
      <button id="btn-translate">中英對照</button>
      <button id="btn-english">只有英文</button>
    </div>
  </div>
  
  <!-- 考試設定區 -->
  <div id="examSettings">
    <h2>考試設定</h2>
    <div>
      <label>暱稱：
        <input type="text" id="examNickname" placeholder="請輸入暱稱">
      </label>
      <span id="defaultNickDisp" style="margin-left:10px;">預設：<em id="defaultNickEm"></em></span>
      <button id="randomNickBtn">隨機</button>
    </div>
    <div>
      <label>作答時間 (秒)：
        <input type="number" id="examTime" min="1" max="100" placeholder="1-100">
      </label>
      <span>（若空，預設 5 秒）</span>
    </div>
    <div>
      <label>
        <input type="radio" name="examMode" value="repeat">
        隨機
      </label>
      <label>
        <input type="radio" name="examMode" value="nonrepeat" checked>
        隨機不重複
      </label>
    </div>
    <div style="margin-top:10px;">
      <button id="startExamBtn">考 試</button>
    </div>
  </div>
  
  <!-- 考試模式 -->
  <div id="examPanel">
    <h2>考試進行中</h2>
    <p class="examInfo">題號：<span id="examQNo"></span> / 10</p>
    <!-- 題目英文單字按鈕（點擊可重播語音） -->
    <button id="examQuestionBtn" class="questionWord"></button>
    <div id="optionsContainer"></div>
    <p class="examInfo">剩餘作答時間：<span id="examTimer">0.00</span> 秒</p>
    <p class="examInfo">總作答時間：<span id="totalTime">0.00</span> 秒</p>
    <p class="examInfo">目前得分：<span id="examScore">0</span></p>
    <!-- header 的【結束考試】按鈕同步控制，於此區不再重複顯示 -->
    <!-- 答錯時顯示正確答案與圖片 -->
    <div id="correctDisplay"></div>
    <!-- 當答錯時顯示【下一題】按鈕 -->
    <button id="nextBtn">下一題</button>
  </div>
  
  <!-- 結果與排行榜區 -->
  <div id="resultPanel">
    <h2>考試結束！</h2>
    <p>你的分數：<span id="finalScore"></span> 分，總作答時間：<span id="finalTime"></span> 秒</p>
    <button onclick="location.reload()">重新考試</button>
    <h2>排行榜</h2>
    <table id="leaderboardTable">
      <thead>
        <tr>
          <th>名次</th>
          <th>暱稱</th>
          <th>分數</th>
          <th>總作答時間 (秒)</th>
        </tr>
      </thead>
      <tbody id="leaderboardBody"></tbody>
    </table>
  </div>
  
  <!-- 全站排行榜 -->
  <div id="globalLeaderboard">
    <h2>排行榜</h2>
    <table id="globalLeaderboardTable">
      <thead>
        <tr>
          <th>名次</th>
          <th>暱稱</th>
          <th>分數</th>
          <th>總作答時間 (秒)</th>
        </tr>
      </thead>
      <tbody id="globalLeaderboardBody"></tbody>
    </table>
  </div>
  
  <script>
    /* ===============================
       資料定義
    =============================== */
    const wordsData = [
      { word: "apple",      translation: "蘋果",      image: "apple.png" },
      { word: "book",       translation: "書",        image: "book.png" },
      { word: "cat",        translation: "貓",        image: "cat.png" },
      { word: "dog",        translation: "狗",        image: "dog.png" },
      { word: "egg",        translation: "蛋",        image: "egg.png" },
      { word: "fish",       translation: "魚",        image: "fish.png" },
      { word: "goat",       translation: "山羊",      image: "goat.png" },
      { word: "hand",       translation: "手",        image: "hand.png" },
      { word: "ice cream",  translation: "冰淇淋",    image: "icecream.png" },
      { word: "joke",       translation: "笑話",      image: "joke.png" }
    ];
    // 隨機暱稱資料（示範數量，可自行擴充至20+項）
    const animals = ["蜜獾", "北極熊", "熊貓", "無尾熊", "樹懶", "浣熊", "老虎", "獅子", "大象", "猴子"];
    const people = ["金城武", "車銀優", "梁山伯", "祝英台", "孔子", "孫中山", "岳飛", "武則天", "周恩來", "鄧小平"];
    const titles = ["船長", "總統", "將軍", "博士", "教授", "主任", "先生", "小姐", "大師", "專家"];
    const countries = ["美國", "新加坡", "英國", "法國", "日本", "韓國", "中國", "台灣", "紐西蘭", "凡蒂岡"];
    function shuffleArray(array) {
      for(let i = array.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }
    function randomTwoLetters() {
      const letters = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";
      return letters.charAt(Math.floor(Math.random()*letters.length)) +
             letters.charAt(Math.floor(Math.random()*letters.length));
    }
    function randomFourDigits() {
      let num = Math.floor(Math.random() * 10000);
      return num.toString().padStart(4, "0");
    }
    function generateRandomNickname() {
      const useAnimal = Math.random() < 0.5;
      const name = useAnimal 
          ? animals[Math.floor(Math.random()*animals.length)]
          : people[Math.floor(Math.random()*people.length)];
      const title = titles[Math.floor(Math.random()*titles.length)];
      const country = countries[Math.floor(Math.random()*countries.length)];
      return name + title + "-" + country + randomTwoLetters() + randomFourDigits();
    }
    
    /* ===============================
       模式切換：學習模式 & 考試模式設定
    =============================== */
    const vocabPanel = document.getElementById("vocabPanel");
    const examSettings = document.getElementById("examSettings");
    const examPanel = document.getElementById("examPanel");
    const resultPanel = document.getElementById("resultPanel");
    
    function showMode(mode) {
      if(mode === "vocab") {
        vocabPanel.style.display = "block";
        examSettings.style.display = "none";
        examPanel.style.display = "none";
        resultPanel.style.display = "none";
        document.getElementById("headerFinishExamBtn").style.display = "none";
      } else if(mode === "examSetup") {
        vocabPanel.style.display = "none";
        examSettings.style.display = "block";
        examPanel.style.display = "none";
        resultPanel.style.display = "none";
        const defNick = generateRandomNickname();
        document.getElementById("defaultNickEm").textContent = defNick;
        document.getElementById("examNickname").value = defNick;
        document.getElementById("headerFinishExamBtn").style.display = "none";
      }
    }
    // 預設顯示學習模式
    showMode("vocab");
    
    /* ===============================
       學習模式建立
    =============================== */
    const vocabContainer = document.getElementById("vocabContainer");
    wordsData.forEach((item, index) => {
      const div = document.createElement("div");
      div.className = "word-container";
      div.id = "vocab-" + index;
      const btn = document.createElement("button");
      btn.textContent = item.word;
      btn.addEventListener("click", () => { speakWord(item.word); });
      div.appendChild(btn);
      const extraDiv = document.createElement("div");
      extraDiv.className = "extra";
      extraDiv.id = "extra-" + index;
      div.appendChild(extraDiv);
      vocabContainer.appendChild(div);
    });
    function speakWord(text) {
      window.speechSynthesis.cancel();
      const utt = new SpeechSynthesisUtterance(text);
      utt.lang = "en-US";
      window.speechSynthesis.speak(utt);
    }
    document.getElementById("btn-translate").addEventListener("click", () => {
      wordsData.forEach((item, index) => {
        document.getElementById("extra-" + index).innerHTML = `<img src="${item.image}" alt="${item.word}"><br>${item.translation}`;
      });
    });
    document.getElementById("btn-english").addEventListener("click", () => {
      wordsData.forEach((item, index) => {
        document.getElementById("extra-" + index).innerHTML = "";
      });
    });
    
    /* ===============================
       考試模式設定區
    =============================== */
    document.getElementById("randomNickBtn").addEventListener("click", () => {
      const newNick = generateRandomNickname();
      document.getElementById("defaultNickEm").textContent = newNick;
      document.getElementById("examNickname").value = newNick;
    });
    
    const startExamBtn = document.getElementById("startExamBtn");
    let examTimeLimit = 5; // 每題作答時間（秒）
    let examQuestions = []; // 考題陣列
    let currentExamIndex = 0;
    let examScore = 0;
    let examTimerInterval;
    let examQuestionStart; // 每題開始計時毫秒
    let examTotalTime = 0; // 累計作答時間（秒）
    let examAnswered = false;
    let examModeOption = "nonrepeat";
    
    document.querySelectorAll('input[name="examMode"]').forEach(radio => {
      radio.addEventListener("change", function() {
        examModeOption = this.value;
      });
    });
    
    startExamBtn.addEventListener("click", startExam);
    
    function startExam() {
      const nickInput = document.getElementById("examNickname").value.trim();
      const userNick = nickInput === "" ? document.getElementById("defaultNickEm").textContent : nickInput;
      localStorage.setItem("nickname", userNick);
      const t = parseInt(document.getElementById("examTime").value);
      examTimeLimit = (!isNaN(t) && t>=1 && t<=100) ? t : 5;
      if(examModeOption === "nonrepeat") {
        examQuestions = wordsData.slice();
        shuffleArray(examQuestions);
      } else {
        examQuestions = [];
        for(let i=0; i<10; i++){
          examQuestions.push(wordsData[Math.floor(Math.random() * wordsData.length)]);
        }
      }
      currentExamIndex = 0;
      examScore = 0;
      examTotalTime = 0;
      document.getElementById("examScore").textContent = examScore;
      // 考試開始後，顯示 header 結束考試按鈕
      document.getElementById("headerFinishExamBtn").style.display = "inline-block";
      examSettings.style.display = "none";
      examPanel.style.display = "block";
      resultPanel.style.display = "none";
      loadExamQuestion();
    }
    
    function loadExamQuestion() {
      examAnswered = false;
      document.getElementById("correctDisplay").innerHTML = "";
      document.getElementById("nextBtn").style.display = "none";
      document.getElementById("optionsContainer").innerHTML = "";
      if(currentExamIndex >= examQuestions.length) {
        finishExam();
        return;
      }
      const currentData = examQuestions[currentExamIndex];
      document.getElementById("examQNo").textContent = currentExamIndex + 1;
      const examQBtn = document.getElementById("examQuestionBtn");
      examQBtn.textContent = currentData.word;
      examQBtn.onclick = () => { playExamWord(currentData.word); };
      // 播放題目語音後立即開始倒數計時
      playExamWord(currentData.word);
      startExamTimer();
      // 產生選項：正確答案與 3 個不重複錯誤答案
      const correct = currentData.translation;
      let wrongArr = wordsData.filter(item => item.translation !== correct)
                              .map(item => item.translation);
      shuffleArray(wrongArr);
      wrongArr = wrongArr.slice(0, 3);
      let options = wrongArr.concat(correct);
      shuffleArray(options);
      options.forEach(opt => {
        const btn = document.createElement("button");
        btn.className = "option";
        btn.textContent = opt;
        btn.onclick = () => { if(!examAnswered) answerExam(opt); };
        document.getElementById("optionsContainer").appendChild(btn);
      });
      document.getElementById("examTimer").textContent = examTimeLimit.toFixed(2);
      document.getElementById("totalTime").textContent = examTotalTime.toFixed(2);
    }
    
    function playExamWord(word) {
      window.speechSynthesis.cancel();
      const utt = new SpeechSynthesisUtterance(word);
      utt.lang = "en-US";
      window.speechSynthesis.speak(utt);
    }
    
    function startExamTimer() {
      examQuestionStart = Date.now();
      clearInterval(examTimerInterval);
      examTimerInterval = setInterval(updateExamTimer, 50);
    }
    
    function updateExamTimer() {
      const elapsed = (Date.now() - examQuestionStart) / 1000;
      let remaining = examTimeLimit - elapsed;
      if(remaining <= 0) {
        remaining = 0;
        document.getElementById("examTimer").textContent = remaining.toFixed(2);
        clearInterval(examTimerInterval);
        if(!examAnswered) {
          examTotalTime += examTimeLimit;
          showCorrectAnswer();
          examAnswered = true;
          document.getElementById("nextBtn").style.display = "inline-block";
        }
      } else {
        document.getElementById("examTimer").textContent = remaining.toFixed(2);
      }
      document.getElementById("totalTime").textContent = (examTotalTime + Math.min(elapsed, examTimeLimit)).toFixed(2);
    }
    
    function answerExam(selected) {
      examAnswered = true;
      clearInterval(examTimerInterval);
      const elapsed = (Date.now() - examQuestionStart) / 1000;
      examTotalTime += Math.min(elapsed, examTimeLimit);
      const currentData = examQuestions[currentExamIndex];
      if(selected === currentData.translation) {
        examScore += 10;
        document.getElementById("examScore").textContent = examScore;
        setTimeout(() => {
          currentExamIndex++;
          loadExamQuestion();
        }, 500);
      } else {
        document.getElementById("examScore").textContent = examScore;
        showCorrectAnswer();
        document.getElementById("nextBtn").style.display = "inline-block";
      }
      document.querySelectorAll("#optionsContainer button.option")
              .forEach(btn => btn.disabled = true);
    }
    
    function showCorrectAnswer() {
      const currentData = examQuestions[currentExamIndex];
      document.getElementById("correctDisplay").innerHTML = `正確答案：${currentData.translation}<br>
        <img src="${currentData.image}" alt="${currentData.word}" id="correctImg">`;
      document.getElementById("correctImg").addEventListener("click", () => {
        speakWord(currentData.word);
      });
    }
    
    document.getElementById("nextBtn").addEventListener("click", () => {
      currentExamIndex++;
      loadExamQuestion();
    });
    
    function finishExam() {
      clearInterval(examTimerInterval);
      examPanel.style.display = "none";
      document.getElementById("headerFinishExamBtn").style.display = "none";
      showResults();
    }
    
    // header 結束考試按鈕
    function headerFinishExam() {
      finishExam();
    }
    
    function showResults() {
      resultPanel.style.display = "block";
      document.getElementById("finalScore").textContent = examScore;
      document.getElementById("finalTime").textContent = examTotalTime.toFixed(2);
      updateLeaderboard();
      uploadExamResult();
    }
    
    /* ===============================
       排行榜（localStorage）
    =============================== */
    function updateLeaderboard() {
      let leaderboard = JSON.parse(localStorage.getItem("leaderboard")) || [];
      const nickname = localStorage.getItem("nickname") || generateRandomNickname();
      leaderboard.push({ nickname: nickname, score: parseInt(examScore, 10), time: parseFloat(examTotalTime.toFixed(2)) });
      leaderboard.sort((a, b) => {
        if(b.score === a.score) return a.time - b.time;
        return b.score - a.score;
      });
      leaderboard = leaderboard.slice(0, 10);
      localStorage.setItem("leaderboard", JSON.stringify(leaderboard));
      displayLeaderboard(leaderboard);
      displayGlobalLeaderboard(leaderboard);
    }
    
    function displayLeaderboard(lb) {
      const lbBody = document.getElementById("leaderboardBody");
      lbBody.innerHTML = "";
      lb.forEach((entry, index) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${index+1}</td>
                        <td>${entry.nickname}</td>
                        <td>${entry.score}</td>
                        <td>${entry.time.toFixed(2)}</td>`;
        lbBody.appendChild(tr);
      });
    }
    
    function displayGlobalLeaderboard(lb) {
      const gBody = document.getElementById("globalLeaderboardBody");
      gBody.innerHTML = "";
      lb.forEach((entry, index) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${index+1}</td>
                        <td>${entry.nickname}</td>
                        <td>${entry.score}</td>
                        <td>${entry.time.toFixed(2)}</td>`;
        gBody.appendChild(tr);
      });
    }
    
    /* ===============================
       公用語音函式
    =============================== */
    function speakWord(text) {
      window.speechSynthesis.cancel();
      const utt = new SpeechSynthesisUtterance(text);
      utt.lang = "en-US";
      window.speechSynthesis.speak(utt);
    }
    
    /* ===============================
       當頁面載入時讀取並顯示全站排行榜
    =============================== */
    window.addEventListener("load", () => {
      const lb = JSON.parse(localStorage.getItem("leaderboard")) || [];
      displayGlobalLeaderboard(lb);
    });
    
    /* ===============================
       Firebase 上傳成績
    =============================== */
    function uploadExamResult() {
      db.collection("examResults").add({
        nickname: localStorage.getItem("nickname"),
        score: examScore,
        time: examTotalTime,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      })
      .then(() => {
        console.log("Exam result uploaded to Firebase.");
      })
      .catch((error) => {
        console.error("Error uploading exam result:", error);
      });
    }
  </script>
</body>
</html>
